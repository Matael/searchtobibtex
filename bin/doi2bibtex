#!/bin/bash
# Ati Sharma 2015
# Pulls bibtex data from doi URL or journal webpage, from known journal types.

# bibtool key format string
BIBKEYFMT='%3n(author)%+4d($year)'
# All the things that you don't want in your bibtex entry, separated by \|
BIBENTRYFILTER='= ,\|\"-\"\|url'

# resolve redirected URLs
URL="$1"
# tempfile to store html
TEMPFILE=/tmp/$RANDOM
# pull out the redirected URL
RED_URL=$(wget -Sq -O $TEMPFILE $URL 2>&1 | grep 'Location' | sed 's/Location: //')

echo "@COMMENT {Generated by doi2bibtex from $URL on $(date)}"

# Test for journal
AIP=$( grep -c 'AIP Publishing' $TEMPFILE)
JFM=$( grep -c 'Journal of Fluid Mechanics' $TEMPFILE)
PRL=$( grep -c 'Physical Review Letters' $TEMPFILE)

# while these tests are needlessly evaluated, it's a lot more readable than nested ifs

# for JFM format
test "$JFM" != "0" && ( grep bibtex $TEMPFILE | sed -e's/<[ \"=a-zA-Z\/]*>/\n/g' | grep -v "$BIBENTRYFILTER" | bibclean -delete-empty-values | bibtool -F -f "$BIBKEYFMT"; )

# for AIP format (incl PoF), find link to bibtex and follow
test "$AIP" != "0" && ( wget -qO- "http://scitation.aip.org/$( grep bibtex $TEMPFILE |  awk -F'"' '{ print $2 }')" | grep -v "$BIBENTRYFILTER" | bibclean -delete-empty-values | bibtool -F -f "$BIBKEYFMT"; )

# for PRL you can just modify the URL
test "$PRL" != "0" && ( wget -qO- $( echo "$RED_URL" | grep 'abstract' | sed 's/abstract/export/' ) | grep -v "$BIBENTRYFILTER" | bibclean -delete-empty-values | bibtool -F -f "$BIBKEYFMT" ; )

rm $TEMPFILE

# TODO: pull down PDF of paper and name appropriately
