#!/bin/bash
#
# NAME
#       doitobibtex
#
# SYNOPSIS
#       doitobibtex DOI
#
# DESCRIPTION
#       Pulls bibtex data from doi URL via crossref API.
#
# COMMENTS
#       Requires bibclean and bibtool, which are distributed as part of texlive distribution.
#
# COPYRIGHT
#       Copyright (C) 2015 Ati Sharma
#
#       This program is free software: you can redistribute it and/or modify
#       it under the terms of the GNU General Public License as published by
#       the Free Software Foundation, either version 3 of the License, or
#       (at your option) any later version.
#       
#       This program is distributed in the hope that it will be useful,
#       but WITHOUT ANY WARRANTY; without even the implied warranty of
#       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#       GNU General Public License for more details.
#       
#       You should have received a copy of the GNU General Public License
#       along with this program.  If not, see <http://www.gnu.org/licenses/>.



# bibtool key format string
BIBKEYFMT='%3n(author)%+4d(year)'
# All the things that you don't want in your bibtex entry, separated by \|
BIBENTRYFILTER='= ,\|\"-\"\|url'

# turn DOI into URL
DOI=$(echo $1 | sed 's/.*doi.org\///')
URL="http://dx.doi.org/$DOI"

#echo "@COMMENT {Generated by doi2bibtex from $URL on $(date)}"

# use crossref API
# see http://www.crossref.org/CrossTech/2011/11/turning_dois_into_formatted_ci.html
# resolve URL
curl -s -LH "Accept: text/bibliography; style=bibtex" $URL | sed 's/,/,\n/g' | sed 's/}}/}\n}/' | grep -v "$BIBENTRYFILTER" | bibclean -delete-empty-values -no-check-values | bibtool -F -f "$BIBKEYFMT";

# TODO: pull down PDF of paper and name appropriately
